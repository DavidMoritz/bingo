# Bingo App Architecture Guide

## Overview
- **Backend**: AWS Amplify Gen 2 (DynamoDB + GraphQL API + Cognito Auth)
- **Frontend**: Vite + React 19 + TypeScript with TanStack Router, React Query, and Tailwind CSS
- **Authentication**: AWS Cognito with email and Google OAuth support
- **CI/CD**: AWS Amplify Hosting with git-based deployments
- **Build/Dev**: Vite powers fast dev server; `npx ampx sandbox` for local backend development; Git push triggers production deployment

## Backend (AWS Amplify)

### Data Models (DynamoDB via GraphQL)
All models use API Key authorization mode (`publicApiKey`) for simplicity.

**Profile**
- `id` (ID): User identifier from Cognito
- `displayName` (String): User's display name
- `email` (String): User's email address
- `createdAt` (DateTime): Profile creation timestamp

**PhraseSet**
- `code` (ID): 6-character alphanumeric identifier (primary key)
- `title` (String): Phrase set title
- `phrases` (String[]): Array of phrases for bingo
- `isPublic` (Boolean): Whether discoverable in public search
- `freeSpace` (Boolean): Whether to use FREE center cell (only relevant for 5×5 grids)
- `ownerProfileId` (String): Profile ID of creator (can be "guest" for anonymous)
- `ownerDisplayName` (String, optional): Display name of creator for better UX
- `ratingTotal` (Int): Sum of all star ratings
- `ratingCount` (Int): Number of ratings submitted
- `ratingAverage` (Float): Calculated average rating
- `createdAt`, `updatedAt` (DateTime): Timestamps

**PlaySession**
- `id` (ID): Session identifier
- `profileId` (String): User who created the session
- `phraseSetCode` (String): Reference to the phrase set
- `phraseSetTitle` (String, optional): Cached title for display
- `gridSize` (Int): Board dimensions (1, 2, 3, 4, or 5)
- `usesFreeCenter` (Boolean): Whether FREE center is enabled
- `boardSnapshot` (AWSJSON): Serialized board state at creation
- `checkedCells` (Int[]): Array of indices of selected cells
- `createdAt`, `updatedAt` (DateTime): Timestamps

**Rating** (Rich-join between Profile and PhraseSet)
- `id` (ID): Rating identifier
- `profileId` (String): User who submitted rating
- `phraseSetCode` (String): Phrase set being rated
- `ratingValue` (Int): 1-5 star rating
- `lastSessionId` (String, optional): Most recent play session reference
- `createdAt`, `updatedAt` (DateTime): Timestamps
- **Uniqueness**: One rating per profileId + phraseSetCode combination
- **Updates**: If user re-rates, updates existing Rating record and adjusts PhraseSet aggregates

**PhraseTemplate** (Cached phrase suggestions)
- `id` (ID): Template identifier
- `genre` (String): Search keyword (e.g., "christmas", "startup", "unicorns")
- `phrases` (String[]): 30 suggested phrases
- `isAiGenerated` (Boolean): Whether generated by AI (future feature)
- `usageCount` (Int): Incremented each time template is used
- `createdAt`, `updatedAt` (DateTime): Timestamps
- **Caching**: First user to search a genre triggers generation/lookup; subsequent users get cached result instantly

### Authentication
- **Provider**: AWS Cognito
- **Methods**: Email/password and Google OAuth
- **Redirect URLs**: Configured for `localhost:5173` (dev) and `localhost:4173` (preview)
- **User Context**: `UserContext` provides `displayName`, `email`, and `profileId` throughout app
- **Unauthenticated access**: Enabled for guest users (API key auth mode)

### Amplify Gen 2 Configuration
- **Backend Code**: `amplify/backend.ts` defines backend resources
- **Data Schema**: `amplify/data/resource.ts` defines all models and authorization rules
- **Auth Config**: `amplify/auth/resource.ts` defines Cognito auth with email and Google OAuth
- **Functions**: `amplify/functions/` directory for Lambda functions (currently only phrase generation)
- **Deployment**:
  - **Local Development**: `npx ampx sandbox` creates isolated sandbox environment with hot-reload
  - **Production**: `git push` triggers CI/CD pipeline via Amplify Hosting
  - **Manual Deploy**: Not recommended in Gen 2 - use git workflow instead
- **Outputs**: `amplify_outputs.json` auto-generated on deployment, contains API endpoints, auth config, and model schemas

## Frontend Stack

### Core Technologies
- **Vite**: Dev server + bundler with hot module reload
- **React 19**: Function components with hooks
- **TypeScript**: Full type safety across components and API
- **Tailwind CSS**: Utility-first styling
- **TanStack Router**: File-free routing with loaders
- **React Query**: Server state management, caching, and mutations

### Routing (`front/src/router.tsx`)
- `/` → Home page (`HomePage`)
- `/create` → Create/edit phrase sets (`CreatePage`)
- `/join` → Join via code or search public sets (`JoinPage`)
- `/login` → Authentication UI (`LoginPage`)
- `/profile` → View created boards and play sessions (`ProfilePage`)
- `/game/$code` → Play bingo with phrase set (`GamePage`)
  - Loader checks for existing session, fetches phrase set
  - Smart logic: if user has played this code before, loads their session
- `/session/$id` → Resume saved session (`SessionGameWrapper`)
  - Loads session + fetches real phrase set for owner info

### State Management
- **React Query**: Server state (phrase sets, sessions, ratings, templates)
- **UserContext**: Authentication state (profileId, email, displayName)
- **Local State**: Component UI state via `useState`

## Frontend Features

### Create Flow (`front/src/pages/Create.tsx`)
- **Phrase Suggestions**: Searches `PhraseTemplate` by genre
  - If found: returns cached phrases, increments `usageCount`
  - If not found: shows error with available genres
  - Merge mode: appends suggestions if user edited phrases, otherwise replaces
- **Grid Preview**: Shows current grid size (1×1 to 5×5) based on phrase count
- **Phrase Syntax**:
  - One phrase per line
  - `*Phrase` for priority (guaranteed inclusion)
  - `A | B` for OR options (randomly picks one)
- **Options**:
  - `Public`: Makes phrase set discoverable (default: off)
  - `Free space`: Enables FREE center (auto-locked for <25 phrases)
- **Ownership**: Stores both `ownerProfileId` and `ownerDisplayName` for better display

### Join Flow (`front/src/pages/Join.tsx`)
- **Direct Entry**: Enter code → navigate to `/game/$code`
- **Public Search**: Query phrase sets by title or code
  - Results sorted by rating (desc) then recency
  - Shows title, code, phrase count, rating, created date

### Game Flow (`front/src/pages/Game.tsx`)
- **Board Generation**: Dynamic grid sizing
  - 1-3 phrases → 1×1 grid
  - 4-8 phrases → 2×2 grid
  - 9-15 phrases → 3×3 grid
  - 16-23 phrases → 4×4 grid
  - 24+ phrases → 5×5 grid (FREE center if enabled)
- **Session Persistence**:
  - Creates `PlaySession` on first cell click
  - Saves board snapshot and checked cells
  - Updates on every cell toggle
- **Rating System**:
  - Queries `Rating` table to check if user already rated
  - If already rated: shows "Thank you for your feedback!"
  - If not rated: shows star rating widget (1-5)
  - Prevents duplicate ratings (one per user per phrase set)
  - Updates adjust existing rating rather than creating duplicates
- **Ownership Display**: Shows `ownerDisplayName` if available, otherwise "Anonymous user" or "guest"
- **Claim Ownership**: Guest phrase sets can be claimed by signed-in users
- **Reshuffle**: Generates new random board from same phrase set

### Profile Page (`front/src/pages/Profile.tsx`)
- **My Boards**: Lists phrase sets owned by user
  - Edit functionality: update title, phrases, visibility, free space
  - Remove from profile: sets `ownerProfileId` to "guest"
- **Play Sessions**: Shows past games with resume links
  - Displays title, grid size, checked cell count, created date
  - Click to resume game at `/session/$id`

## Utilities and Logic

### Board Generation (`front/src/lib/bingo.ts`)
- Parses phrases and resolves OR syntax (`A | B`)
- Prioritizes phrases marked with `*` (shuffled first)
- Fills remaining slots with non-priority phrases (shuffled)
- Deduplicates phrases
- Auto-determines grid size based on phrase count
- Inserts FREE center only for 5×5 grids when enabled

### API Layer (`front/src/lib/api.ts`)
- **Amplify Client**: Singleton `getDataClient()` with API key auth mode
- **PhraseSet Operations**: create, fetch, update, list (my sets + public), claim ownership, orphan
- **PlaySession Operations**: create, update checked cells, fetch by ID, list user's sessions
- **Rating Operations**: fetch user's rating, submit/update rating (maintains uniqueness)
- **Phrase Suggestions**: Query `PhraseTemplate` by genre, increment usage count
- **Code Generation**: Browser-compatible random 6-character codes (excludes confusing chars: O, 0, I, 1)

### Data Serialization
- **PlaySession.boardSnapshot**: Stored as JSON string (AWSJSON type), parsed on read
- **PlaySession.checkedCells**: Stored as integer array

## Styling
- **Tailwind CSS**: All styling via utility classes (no separate CSS modules)
- **Color Scheme**: Dark theme with teal accents, slate backgrounds, white text
- **Responsive**: Mobile-first design with sm/lg breakpoints
- **Effects**: Gradients, blur, shadows, transitions, hover states

## Running and Building

### Amplify Gen 2 Workflow

**Key Concept**: Git is the source of truth. Backend configuration is code in the `amplify/` directory.

#### Local Development
```bash
# 1. Pull latest changes from team
git pull

# 2. Start backend sandbox (creates isolated environment)
npx ampx sandbox
# - Deploys backend to cloud sandbox
# - Watches for changes and hot-reloads
# - Generates amplify_outputs.json
# - Each developer gets their own sandbox

# 3. Start frontend (in separate terminal)
cd front
npm run dev      # Vite dev server (port 5173)
```

#### Production Deployment
```bash
# 1. Make changes to amplify/ or front/
# 2. Commit changes
git add .
git commit -m "Add new feature"

# 3. Push to trigger deployment
git push
# - Amplify Hosting detects push
# - Runs build via amplify.yml configuration
# - Deploys backend (if enabled in amplify.yml)
# - Builds and deploys frontend
```

#### Build Configuration (`amplify.yml`)
The project uses a monorepo structure with frontend in `front/` subdirectory:
- **appRoot: front** - Sets working directory for frontend commands
- **Backend phase**: Runs `npx ampx pipeline-deploy` (currently disabled for faster builds)
- **Frontend phase**: Runs `npm ci` and `npm run build` from `front/` directory
- **Artifacts**: Collected from `front/dist/`

**Fast builds** (~2 min): Backend deployment disabled, only frontend builds
**Full builds** (~9 min): Backend + frontend deployment (uncomment backend section in amplify.yml)

#### Other Commands
```bash
# Frontend testing
cd front
npm test         # Run Vitest tests
npm run build    # TypeScript check + production build
npm run preview  # Preview production build

# Legacy backend (deprecated Express API, still used for suggestions)
npm run dev      # Start Express server (port 3000)
npm run build    # Compile TypeScript
npm test         # Run backend tests
```

### Environment Variables
- **Google OAuth**: Set in Amplify Console under app settings
  - `GOOGLE_CLIENT_ID`
  - `GOOGLE_CLIENT_SECRET`
- **VITE_API_URL**: Set to Express API URL for phrase suggestions (defaults to `http://localhost:3000`)
  - Note: Express API still handles phrase suggestions; not yet migrated to Amplify function

### Testing
- **Backend**: `npm test` (Vitest, no network binding) - **Note**: Tests are for deprecated Express API
- **Frontend**: `cd front && npm test` (Vitest + jsdom)
  - Tests board generation logic (`bingo.test.ts`)
  - Priority phrases, OR syntax, grid sizing, FREE center

## Migration Notes

### Express API Status (`src/` directory)
The Express backend is **partially deprecated**:

- ✅ **Migrated to Amplify**:
  - Phrase sets → `PhraseSet` model (DynamoDB)
  - Ratings → `Rating` model with proper uniqueness constraints
  - Phrase templates → `PhraseTemplate` model with caching
  - Public search → GraphQL list queries with filters

- ⚠️ **Still Using Express**:
  - Phrase suggestions endpoint (`POST /phrase-suggestions`)
  - Reads from `src/suggestions/*.json` templates
  - Frontend calls `VITE_API_URL` for suggestions
  - Not yet migrated to Amplify function

**To complete migration:**
1. Create Amplify function for phrase suggestions
2. Migrate suggestion logic to Lambda
3. Update frontend to call GraphQL mutation instead of REST endpoint
4. Remove Express API and dependencies

### Phrase Templates
12 phrase templates available from Express API (`src/suggestions/*.json`):
- amusement, beach, city, birthday, christmas, fireworks, mountain, office, parade, startup, wedding, zoo

These need to be seeded into `PhraseTemplate` DynamoDB table via migration script (`npm run seed-templates`)

### Future Enhancements

**AI-Generated Templates**
Currently, if a genre isn't found, an error is shown. Future implementation:
1. User searches for "unicorns" (not in cache)
2. Call AI API (Claude, GPT, etc.) to generate 30 phrases
3. Save result as `PhraseTemplate` with `isAiGenerated: true`
4. Return phrases to user
5. Next user searching "unicorns" gets instant cached result

**Amplify Function Example**:
```typescript
// amplify/functions/generate-phrases/handler.ts
export async function handler(event) {
  const { genre } = event.arguments
  const phrases = await callAIAPI(genre) // Claude/GPT call
  await savePhraseTemplate(genre, phrases, true)
  return phrases
}
```

## CI/CD and Deployment

### Amplify Hosting Pipeline
- **Trigger**: Automatic on `git push` to `main` branch
- **Build Environment**: AWS CodeBuild (Standard compute: 8GB memory, 4 vCPUs)
- **Build Configuration**: `amplify.yml` in repository root
- **Deployment Time**:
  - Frontend-only: ~2 minutes
  - Backend + Frontend: ~9 minutes (includes CloudFormation stack updates)

### Build Process
1. **Clone Repository**: Checks out code from GitHub
2. **Cache Retrieval**: Loads cached dependencies if available
3. **Backend Build** (if enabled):
   - Installs root dependencies (`npm ci`)
   - Runs `npx ampx pipeline-deploy`
   - Synthesizes CDK stacks
   - Deploys CloudFormation changes to DynamoDB, AppSync, Cognito, Lambda
   - Generates `amplify_outputs.json`
4. **Frontend Build**:
   - Changes to `front/` directory (via `appRoot` setting)
   - Installs frontend dependencies (`npm ci`)
   - Runs TypeScript compilation and Vite build
   - Outputs to `front/dist/`
5. **Artifact Upload**: Uploads `dist/` contents to S3 and CloudFront
6. **Cache**: Saves `node_modules` for next build

### Environment Configuration
- **Sandbox**: Each developer gets isolated sandbox via `npx ampx sandbox`
  - Separate CloudFormation stacks
  - Separate DynamoDB tables
  - Does not affect production
- **Production**: Single production environment deployed via Amplify Hosting
  - Shared by all users
  - Triggered by git push
  - Managed by `pipeline-deploy`

### Deployment History
Deployment logs saved in `deployment-logs/` for troubleshooting:
- `BUILD.txt`: Complete build output
- `DEPLOY.txt`: Deployment status

## Architecture Decisions

**Why API Key Auth?**
- Simplifies initial development
- Allows guest users to create phrase sets
- Future: migrate to Cognito User Pools auth for row-level security

**Why DynamoDB?**
- Serverless, auto-scaling
- Simple key-value access patterns
- Cost-effective for this use case

**Why Rich-Join for Ratings?**
- Enforces one-rating-per-user-per-phraseset
- Tracks rating history (`lastSessionId`)
- Enables future features (edit ratings, rating notifications)

**Why Cache Phrase Templates?**
- Reduces API costs for AI generation
- Improves response time (instant vs. 5-10 seconds)
- Tracks popularity via `usageCount`

## Data Persistence
- **DynamoDB**: All data persists across restarts
- **Sessions**: Saved automatically on first cell click, updated on every toggle
- **Ratings**: One per user per phrase set, updates replace (not append)
- **Templates**: Cached indefinitely, `usageCount` tracks popularity
